<!doctype html>
<html>
	<head>
		<title>cosmoz-omnitable fit-dropdowns tests</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

		<script src="../../webcomponentsjs/webcomponents-lite.js"></script>
		<script src="../../web-component-tester/browser.js"></script>
		<script src="../../test-fixture/test-fixture-mocha.js"></script>

		<link rel="import" href="../../test-fixture/test-fixture.html">
		<link rel="import" href="../../iron-test-helpers/iron-test-helpers.html">
		<link rel="import" href="helpers.html">
		<link rel="import" href="../cosmoz-omnitable.html">
		<link rel="import" href="../cosmoz-omnitable-column-autocomplete.html">
		<link rel="import" href="../cosmoz-omnitable-column.html">
	</head>
	<body>
		<test-fixture id="basic">
			<template>
				<cosmoz-omnitable hash-param="test" style='height:300px'>
					<cosmoz-omnitable-column-autocomplete width="40px" title="Id" name="id" value-path="id" sort-on="id" group-on="id">
						<template class="cell">
							<span>[[ item.id ]]</span>
						</template>
					</cosmoz-omnitable-column-autocomplete>
					<cosmoz-omnitable-column-autocomplete title="Group" name="group" value-path="group" flex="0" width="125px">
					</cosmoz-omnitable-column-autocomplete>
					<cosmoz-omnitable-column title="Name" name="name" value-path="name" sort-on="name" group-on="name" flex="2">
						<template class="cell">
							<span>[[ item.name ]]</span>
						</template>
					</cosmoz-omnitable-column>
				</cosmoz-omnitable>
			</template>
		</test-fixture>

		<script>
		(function () {
			/* global setupOmnitableFixture*/
			let omnitable;
			const data = [
					{ id: 0, group: 'group0', name: 'Item 0' },
					{ id: 1, group: 'group0', name: 'Item 1' },
					{ id: 2, group: 'group1', name: 'Item 2' },
					{ id: 3, group: 'group1', name: 'Item 3' }
				],
				instantiate = function (done) {
					omnitable = setupOmnitableFixture('basic', data, () => done());
				};

			suite('fit-dropdowns', () => {
				test('sets iron-dropdown fitInto property', done => {
					instantiate(() => {
						[
							omnitable.$.groupOnSelector,
							omnitable.$.sortOnSelector
						]
							.map(d => d.$.menuButton)
							.concat([omnitable.$.bottomBar.$.menu])
							.forEach(button => {
								assert.equal(button.$.dropdown.fitInto, omnitable);
							});
						done();
					});
				});
			});

			suite('autocomplete unit tests', () => {
				test('getComparableValue returns value converted to String', done => {
					instantiate(() => {
						const column = omnitable.columns[0];
						assert.equal(column.getComparableValue({ id: 14, group: 'group0', name: 'Item 14' }), 14);
						assert.equal(column.getComparableValue({ id: 345, group: 'group7', name: 'Item 345' }), 345);
						assert.equal(column.getComparableValue({ id: 27, group: 'group5', name: 'Item 27' }), 27);
						done();
					});
				});

				test('getString handles undefined valuePath parameter', done => {
					instantiate(() => {
						const column = omnitable.columns[0];
						assert.equal(column.getString({ id: 70, group: 'group0', name: 'Item 0' }), 70);
						assert.equal(column.getString({ id: 41, group: 'group4', name: 'Item 41' }), 41);
						assert.equal(column.getString({ id: 126, group: 'group12', name: 'Item 126' }), 126);
						done();
					});
				});

				test('getString handles itemValue as empty array', done => {
					instantiate(() => {
						const column = omnitable.columns[0];
						assert.equal(column.getString({ id: [], group: 'group0', name: 'Item 0' }), '');
						done();
					});
				});

				test('getString handles itemValue as array', done => {
					instantiate(() => {
						const column = omnitable.columns[0];
						assert.equal(column.getString({ id: [70, 80], group: 'group0', name: 'Item 0' }), '70, 80');
						assert.equal(column.getString({ id: [32, 743, -39, 285], group: 'group13', name: 'Item 32' }), '32, 743, -39, 285');
						done();
					});
				});

				test('getString handles itemValue as object', done => {
					instantiate(() => {
						const column = omnitable.columns[0];
						assert.equal(column.getString({ id: { text: '10'}, group: 'group0', name: 'Item 0' }), '10');
						assert.equal(column.getString({ id: { text: '448'}, group: 'group14', name: 'Item 448' }), '448');
						assert.equal(column.getString({ id: { text: '11'}, group: 'group11', name: 'Item 11' }), '11');
						done();
					});
				});

				test('toXlsxValue handles undefined valuePath', done => {
					instantiate(() => {
						const column = omnitable.columns[0];
						column.valuePath = null;
						assert.equal(column.toXlsxValue({ id: 30, group: 'group0', name: 'Item 30' }), '');
						done();
					});
				});

				test('_applySingleFilter filters some string', done => {
					instantiate(() => {
						const column = omnitable.columns[0];
						assert.isTrue(column._applySingleFilter('some', { id: 'some', group: 'group0', name: 'Item 30' }));
						done();
					});
				});

				test('_applyMultiFilter handles null value', done => {
					instantiate(() => {
						const column = omnitable.columns[0];
						assert.isFalse(column._applyMultiFilter([], {id: null, group: 'group0', name: ' Item id null' }));
						done();
					});
				});

				test('_unique handles undefined values', done => {
					instantiate(() => {
						const column = omnitable.columns[0];
						assert.isUndefined(column._unique());
						done();
					});
				});

				test('_unique handles unique values', done => {
					instantiate(() => {
						const column = omnitable.columns[0],
							items = [
								{id: 0, group: 'group0', name: ' Item 0'},
								{id: 1, group: 'group0', name: ' Item 1'},
								{id: 2, group: 'group1', name: ' Item 2'}
							];
						assert.deepEqual(column._unique(items, 'id'), items);
						done();
					});
				});

				test('_unique returns unique values', done => {
					instantiate(() => {
						const column = omnitable.columns[0];
						let items = [
							{id: 0, group: 'group0', name: ' Item 0'},
							{id: 1, group: 'group0', name: ' Item 1'},
							{id: 0, group: 'group0', name: ' Item 0'},
						];
						assert.deepEqual(column._unique(items, 'id'), [
							{id: 0, group: 'group0', name: ' Item 0'},
							{id: 1, group: 'group0', name: ' Item 1'}
						]);

						items = [
							{id: 0, group: 'group0', name: ' Item 0'},
							{id: 1, group: 'group0', name: ' Item 1'},
							{id: 0, group: 'group0', name: ' Item 0'},
							{id: 1, group: 'group0', name: ' Item 1'},
							{id: 2, group: 'group1', name: ' Item 2'},
							{id: 2, group: 'group1', name: ' Item 2'},
							{id: 3, group: 'group1', name: ' Item 3'},
							{id: 0, group: 'group0', name: ' Item 0'},
						];
						assert.deepEqual(column._unique(items, 'id'), [
							{id: 0, group: 'group0', name: ' Item 0'},
							{id: 1, group: 'group0', name: ' Item 1'},
							{id: 2, group: 'group1', name: ' Item 2'},
							{id: 3, group: 'group1', name: ' Item 3'}
						]);
						done();
					});
				});
			});
		})();
		</script>
	</body>
</html>
